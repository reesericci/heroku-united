#!/bin/bash

if ! command -v docker &> /dev/null; then
  printf "Docker is not installed on this server. You may want to run:\n\ncurl https://get.docker.com | sudo bash \n\nto install Docker"
  exit 1
fi

if ! command -v curl &> /dev/null; then
  printf "cURL is not installed on this server."
  exit 1
fi

printf "Installing United to /srv/united/...\n\n"

curl https://codeberg.org/reesericci/united/archive/main.tar.gz | tar -xz -C /srv/

cd /srv/united

tee .env <<EOF &> /dev/null 
SECRET_KEY_BASE=\"$(docker run -it --rm intel/qat-crypto-base:qatsw-ubuntu openssl rand -base64 48)\"
RAILS_MASTER_KEY=\"$(docker run -it --rm intel/qat-crypto-base:qatsw-ubuntu openssl rand -base64 48)\"
EOF

read -p "Would you like to enable HTTPS? (y/N)" -n 1 -e -r https

if [[ $https =~ ^[Yy]$ ]]; then
  printf "What's your external domain?\n"
  read -e -r domain
  fqdn="${domain#http*://}"
  printf "TLS_DOMAIN=${fqdn}" | tee -a .env
fi

docker compose build

tee /etc/systemd/system/united.service <<'END' &> /dev/null
[Unit]
Description=United
After=docker.service

[Service]
Type=simple
DynamicUser=yes
ReadWritePaths=/srv/united/db /srv/united/log /srv/united/storage/ /run /var
ReadOnlyPaths=/
SupplementaryGroups=docker
InaccessiblePaths=-/lost+found
NoExecPaths=/
ExecPaths=/usr/bin/docker /usr/bin/bash /usr/lib /usr/lib64 /srv/united/bin/ /usr/libexec/docker/ /usr/bin/id /usr/bin/chown
Restart=on-failure
WorkingDirectory=/srv/united/
StateDirectory=united
LogsDirectory=united
ExecStart=/usr/bin/bash -c "FIXUID=$(id -u) FIXGID=$(id -g) docker compose up --remove-orphans"
ExecStop=/usr/bin/docker compose down

[Install]
WantedBy=multi-user.target
END

systemctl daemon-reload

systemctl enable united.service

systemctl start united.service

sleep 2m

systemctl status united.service

printf "\n\nUnited is now available at: [ip address of your server]:$(docker compose port web 80)"
